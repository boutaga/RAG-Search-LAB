<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pgvector "Similarity & RAG Search essentials chatbot"</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for the chat bubble arrow */
        .chat-bubble:before {
            content: '';
            position: absolute;
            top: 0;
            left: -10px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid #f3f4f6; /* bg-gray-100 */
        }
        /* Styles for the results table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .results-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto max-w-4xl p-4">
        
        <!-- Header -->
        <header class="py-4 flex justify-between items-center">
            <div>
                <!-- **UPDATED**: h1 title changed as requested -->
                <h1 class="text-2xl font-bold text-gray-800">pgvector Similarity & RAG Search</h1>
                <p class="text-sm text-gray-500 mt-1">Demo on PostgreSQL</p>
            </div>
            <!-- Search Mode Selector Dropdown -->
            <div>
                <label for="search-mode-select" class="sr-only">Select Search Mode</label>
                <select id="search-mode-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <optgroup label="Similarity Search">
                        <option value="cosine">Cosine Search (Raw SQL)</option>
                        <option value="l2">L2 Search (Raw SQL)</option>
                    </optgroup>
                    <optgroup label="RAG Search">
                        <option value="rag_context_only">RAG (Context Only)</option>
                        <option value="rag_open">RAG (Open Fallback)</option>
                    </optgroup>
                </select>
            </div>
            <button id="toggle-logs" class="text-sm text-blue-600 underline ml-4">Show Logs</button>
        </header>

        <!-- Main Content Area -->
        <main class="bg-white p-6 rounded-lg shadow-md">
            <!-- Search Input Area -->
            <div class="flex items-start space-x-4">
                <div class="w-full">
                    <div id="prompt-container" class="bg-blue-500 text-white p-4 rounded-lg relative">
                        <p id="prompt-text">Choose a Search mode in the menu and ask your question : </p>
                    </div>
                </div>
            </div>

            <!-- Response Display Area -->
            <div id="response-container" class="mt-6 hidden">
                 <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l.707-.707M6.343 17.657l-.707.707m12.728 0l.707-.707M18.364 5.636l.707-.707M6 21V10a6 6 0 0112 0v11"></path></svg>
                    </div>
                    <div class="w-full">
                        <div id="response-bubble" class="bg-gray-100 p-4 rounded-lg relative chat-bubble">
                            <!-- This div will hold either the text or the table -->
                            <div id="response-content"></div>
                            <div id="loading-indicator" class="flex items-center space-x-2 hidden">
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                                <span class="text-sm text-gray-500">Thinking...</span>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- New Question Input -->
            <div class="mt-8">
                <div class="relative">
                    <input type="text" id="new-question-input" class="w-full py-3 px-4 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a new question...">
                    <button id="send-button" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 text-white rounded-full p-2 hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.172 16V4.828a1 1 0 00-1.788-.894l-5 2.5a1 1 0 00.217 1.862l1.631.544V14.5a1 1 0 001 1h4.5a1 1 0 001-1V9.862l1.631-.544a1 1 0 00.217-1.862l-5-2.5z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="metrics-section" class="mt-4 hidden">
              <h2 class="text-md font-semibold mb-2">Recent Query Logs</h2>
              <div id="metrics-content" class="text-sm text-gray-700"></div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Element References ---
        const sendButton = document.getElementById('send-button');
        const newQuestionInput = document.getElementById('new-question-input');
        const promptText = document.getElementById('prompt-text');
        const responseContainer = document.getElementById('response-container');
        const responseContent = document.getElementById('response-content');
        const loadingIndicator = document.getElementById('loading-indicator');
        const searchModeSelect = document.getElementById('search-mode-select');
        const toggleLogsBtn = document.getElementById('toggle-logs');
        const metricsSection = document.getElementById('metrics-section');
        const metricsContent = document.getElementById('metrics-content');
        let metricDescriptions = {};

        // Load column descriptions
        fetch('http://127.0.0.1:5000/metric_descriptions')
            .then(r => r.json())
            .then(d => { metricDescriptions = d; })
            .catch(() => { metricDescriptions = {}; });

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendQuestion);
        newQuestionInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleSendQuestion();
        });
        toggleLogsBtn.addEventListener('click', handleToggleLogs);

        // --- Helper function to create results table ---
        function createTableFromData(data) {
            if (!data || data.length === 0) {
                return '<p class="text-gray-700">No results found.</p>';
            }
            const headers = Object.keys(data[0]);
            let table = '<table class="results-table">';
            // Headers
            table += '<thead><tr>';
            headers.forEach(h => {
                const desc = metricDescriptions[h] || '';
                table += `<th title="${desc}">${h}</th>`;
            });
            table += '</tr></thead>';
            // Body
            table += '<tbody>';
            data.forEach(row => {
                table += '<tr>';
                headers.forEach(h => {
                    let value = row[h];
                    if (typeof value === 'number') {
                        value = value.toFixed(4); // Format distance
                    }
                    if (h === 'url' && value) {
                         table += `<td><a href="${value}" target="_blank" class="text-blue-600 hover:underline">Link</a></td>`;
                    } else {
                         table += `<td>${value || ''}</td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // --- Main Handler ---
        async function handleSendQuestion() {
            const question = newQuestionInput.value.trim();
            if (!question) return;

            const searchMode = searchModeSelect.value;

            // 1. Update UI
            promptText.textContent = question;
            newQuestionInput.value = '';
            
            responseContainer.classList.remove('hidden');
            responseContent.innerHTML = '';
            loadingIndicator.classList.remove('hidden');

            try {
                // 2. Send request
                const backendUrl = 'http://127.0.0.1:5000/search';
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: question,
                        search_mode: searchMode 
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // 3. Display response based on its type
                loadingIndicator.classList.add('hidden');
                if (data.response_type === 'raw_sql') {
                    responseContent.innerHTML = createTableFromData(data.results);
                } else { // Assumes 'llm_answer'
                    responseContent.innerHTML = `<p class="text-gray-700 whitespace-pre-wrap">${data.answer}</p>`;
                }

            } catch (error) {
                // 4. Display errors
                console.error('Error fetching data:', error);
                loadingIndicator.classList.add('hidden');
                responseContent.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}. Make sure the backend server is running.</p>`;
            }
        }

        async function handleToggleLogs() {
            if (metricsSection.classList.contains('hidden')) {
                try {
                    const res = await fetch('http://127.0.0.1:5000/metrics');
                    if (!res.ok) throw new Error('Failed to fetch logs');
                    const logData = await res.json();
                    metricsContent.innerHTML = logData.length ? createTableFromData(logData) : '<p>No logs available.</p>';
                    metricsSection.classList.remove('hidden');
                    toggleLogsBtn.textContent = 'Hide Logs';
                } catch (err) {
                    metricsContent.innerHTML = `<p class="text-red-500">Error loading logs: ${err.message}</p>`;
                    metricsSection.classList.remove('hidden');
                }
            } else {
                metricsSection.classList.add('hidden');
                toggleLogsBtn.textContent = 'Show Logs';
            }
        }
    </script>
</body>
</html>
